"""
Comprehensive Test Scenarios for MediBot
Phase 1 & Phase 2 Feature Testing
"""

import os
import requests
import time
import boto3
import pytest

# Configuration
API_URL = "https://khucwqfzv4.execute-api.us-east-1.amazonaws.com/production"
COGNITO_USER_POOL_ID = "us-east-1_9o4GsRj3B"
COGNITO_CLIENT_ID = "n9sr315br32thbf3r28u0p2s7"
CHAT_TABLE = "medibot-chats-production"
IMAGES_BUCKET = "medibot-images-748325220003-us-east-1-production"
REPORTS_BUCKET = "medibot-reports-748325220003-us-east-1-production"
REGION = "us-east-1"

# Integration test guard: requires live API/AWS access
RUN_INTEGRATION = os.getenv("RUN_INTEGRATION_TESTS", "").lower() in {"1", "true", "yes"}
pytestmark = pytest.mark.skipif(
    not RUN_INTEGRATION,
    reason="Integration tests require live API/AWS access. Set RUN_INTEGRATION_TESTS=1 to enable."
)


class TestResult:
    def __init__(self, name: str):
        self.name = name
        self.passed = False
        self.message = ""
        self.duration = 0

    def __str__(self):
        status = "✅ PASS" if self.passed else "❌ FAIL"
        return f"{status} | {self.name} ({self.duration:.2f}s) - {self.message}"


def run_test(test_func) -> TestResult:
    """Run a test function and capture result."""
    result = TestResult(test_func.__name__)
    start = time.time()
    try:
        message = test_func()
        result.passed = True
        result.message = message or "OK"
    except AssertionError as e:
        result.message = str(e)
    except Exception as e:
        result.message = f"Error: {e}"
    result.duration = time.time() - start
    return result


# ============================================
# PHASE 1 TESTS
# ============================================

# --- Health Endpoint Tests ---

def test_health_endpoint_returns_200():
    """Test 1.1: Health endpoint returns 200 status"""
    response = requests.get(f"{API_URL}/health", timeout=10)
    assert response.status_code == 200, f"Expected 200, got {response.status_code}"
    return f"Status: {response.status_code}"


def test_health_endpoint_returns_model_info():
    """Test 1.2: Health endpoint returns model information"""
    response = requests.get(f"{API_URL}/health", timeout=10)
    data = response.json()
    assert "model" in data, "Model field missing"
    assert "gemini" in data["model"].lower(), f"Expected Gemini model, got {data['model']}"
    return f"Model: {data['model']}"


def test_health_endpoint_returns_version():
    """Test 1.3: Health endpoint returns version"""
    response = requests.get(f"{API_URL}/health", timeout=10)
    data = response.json()
    assert "version" in data, "Version field missing"
    return f"Version: {data['version']}"


# --- Chat Endpoint Tests ---

def test_chat_simple_greeting():
    """Test 2.1: Chat handles simple greeting"""
    response = requests.post(
        f"{API_URL}/chat",
        json={"query": "Hello", "generate_images": False},
        timeout=60
    )
    assert response.status_code == 200, f"Expected 200, got {response.status_code}"
    data = response.json()
    assert "answer" in data, "Answer field missing"
    assert len(data["answer"]) > 10, "Response too short"
    return f"Response length: {len(data['answer'])} chars"


def test_chat_medical_query():
    """Test 2.2: Chat handles medical query with steps"""
    response = requests.post(
        f"{API_URL}/chat",
        json={"query": "How to treat a minor cut?", "generate_images": False},
        timeout=60
    )
    assert response.status_code == 200
    data = response.json()
    assert "answer" in data
    # Check for step-by-step format
    assert "step" in data["answer"].lower(), "Expected step-by-step response"
    return "Steps detected in response"


def test_chat_multilingual_telugu():
    """Test 2.3: Chat handles Telugu language"""
    response = requests.post(
        f"{API_URL}/chat",
        json={"query": "చిన్న కత్తి గాయానికి ఏం చేయాలి?", "language": "Telugu", "generate_images": False},
        timeout=60
    )
    assert response.status_code == 200
    data = response.json()
    assert "answer" in data
    return "Telugu response received"


# --- Image Generation Tests ---

def test_image_generation_enabled():
    """Test 3.1: Image generation works when enabled"""
    response = requests.post(
        f"{API_URL}/chat",
        json={"query": "How to perform CPR?", "generate_images": True},
        timeout=90
    )
    assert response.status_code == 200
    data = response.json()
    # Check if step_images exist (may be empty if generation failed)
    return f"Steps count: {data.get('steps_count', 0)}, Images: {len(data.get('step_images', []))}"


def test_image_generation_max_10():
    """Test 3.2: Image generation limited to 10 images"""
    response = requests.post(
        f"{API_URL}/chat",
        json={"query": "How to perform CPR with all steps?", "generate_images": True},
        timeout=90
    )
    assert response.status_code == 200
    data = response.json()
    image_count = len(data.get("step_images", []))
    assert image_count <= 10, f"Expected max 10 images, got {image_count}"
    return f"Image count: {image_count} (max 10)"


def test_images_uploaded_to_s3():
    """Test 3.3: Generated images are uploaded to S3"""
    response = requests.post(
        f"{API_URL}/chat",
        json={"query": "How to bandage a wound?", "generate_images": True},
        timeout=90
    )
    assert response.status_code == 200
    data = response.json()
    step_images = data.get("step_images", [])
    if step_images:
        first_image = step_images[0]
        image_url = first_image.get("image_url", "")
        assert "s3" in image_url.lower() or "amazonaws" in image_url.lower(), "Expected S3 URL"
        return f"S3 URL: {image_url[:60]}..."
    return "No images generated (Gemini may have failed)"


# --- S3 Bucket Tests ---

def test_s3_images_bucket_exists():
    """Test 4.1: Images S3 bucket exists"""
    s3 = boto3.client('s3', region_name=REGION)
    s3.head_bucket(Bucket=IMAGES_BUCKET)
    return f"Bucket exists: {IMAGES_BUCKET}"


def test_s3_images_bucket_has_lifecycle():
    """Test 4.2: Images bucket has lifecycle policy"""
    s3 = boto3.client('s3', region_name=REGION)
    response = s3.get_bucket_lifecycle_configuration(Bucket=IMAGES_BUCKET)
    rules = response.get("Rules", [])
    assert len(rules) > 0, "No lifecycle rules found"
    return f"Lifecycle rules: {len(rules)}"


def test_s3_images_accessible():
    """Test 4.3: Images in S3 are accessible"""
    s3 = boto3.client('s3', region_name=REGION)
    response = s3.list_objects_v2(Bucket=IMAGES_BUCKET, MaxKeys=5)
    count = response.get("KeyCount", 0)
    return f"Objects in bucket: {count}"


# ============================================
# PHASE 2 TESTS
# ============================================

# --- Cognito Tests ---

def test_cognito_user_pool_exists():
    """Test 5.1: Cognito User Pool exists"""
    cognito = boto3.client('cognito-idp', region_name=REGION)
    response = cognito.describe_user_pool(UserPoolId=COGNITO_USER_POOL_ID)
    pool = response.get("UserPool", {})
    assert pool.get("Id") == COGNITO_USER_POOL_ID
    return f"User Pool: {pool.get('Name')}"


def test_cognito_client_exists():
    """Test 5.2: Cognito App Client exists"""
    cognito = boto3.client('cognito-idp', region_name=REGION)
    response = cognito.describe_user_pool_client(
        UserPoolId=COGNITO_USER_POOL_ID,
        ClientId=COGNITO_CLIENT_ID
    )
    client = response.get("UserPoolClient", {})
    assert client.get("ClientId") == COGNITO_CLIENT_ID
    return f"Client: {client.get('ClientName')}"


def test_cognito_password_policy():
    """Test 5.3: Cognito has correct password policy"""
    cognito = boto3.client('cognito-idp', region_name=REGION)
    response = cognito.describe_user_pool(UserPoolId=COGNITO_USER_POOL_ID)
    policies = response.get("UserPool", {}).get("Policies", {})
    password_policy = policies.get("PasswordPolicy", {})
    assert password_policy.get("MinimumLength", 0) >= 8, "Password too short"
    return f"Min length: {password_policy.get('MinimumLength')}"


# --- DynamoDB Tests ---

def test_dynamodb_table_exists():
    """Test 6.1: DynamoDB chat table exists"""
    dynamodb = boto3.client('dynamodb', region_name=REGION)
    response = dynamodb.describe_table(TableName=CHAT_TABLE)
    status = response.get("Table", {}).get("TableStatus")
    assert status == "ACTIVE", f"Expected ACTIVE, got {status}"
    return f"Table status: {status}"


def test_dynamodb_table_schema():
    """Test 6.2: DynamoDB table has correct schema"""
    dynamodb = boto3.client('dynamodb', region_name=REGION)
    response = dynamodb.describe_table(TableName=CHAT_TABLE)
    key_schema = response.get("Table", {}).get("KeySchema", [])
    keys = [k.get("AttributeName") for k in key_schema]
    assert "user_id" in keys, "user_id key missing"
    assert "chat_id" in keys, "chat_id key missing"
    return f"Keys: {keys}"


def test_dynamodb_ttl_enabled():
    """Test 6.3: DynamoDB TTL is enabled"""
    dynamodb = boto3.client('dynamodb', region_name=REGION)
    response = dynamodb.describe_time_to_live(TableName=CHAT_TABLE)
    ttl = response.get("TimeToLiveDescription", {})
    status = ttl.get("TimeToLiveStatus")
    assert status in ["ENABLED", "ENABLING"], f"TTL not enabled: {status}"
    return f"TTL status: {status}"


# --- Reports Bucket Tests ---

def test_reports_bucket_exists():
    """Test 7.1: Reports S3 bucket exists"""
    s3 = boto3.client('s3', region_name=REGION)
    s3.head_bucket(Bucket=REPORTS_BUCKET)
    return f"Bucket exists: {REPORTS_BUCKET}"


def test_reports_bucket_is_private():
    """Test 7.2: Reports bucket blocks public access"""
    s3 = boto3.client('s3', region_name=REGION)
    response = s3.get_public_access_block(Bucket=REPORTS_BUCKET)
    config = response.get("PublicAccessBlockConfiguration", {})
    assert config.get("BlockPublicAcls") is True, "Public ACLs not blocked"
    assert config.get("BlockPublicPolicy") is True, "Public policy not blocked"
    return "All public access blocked"


def test_reports_bucket_encrypted():
    """Test 7.3: Reports bucket has encryption"""
    s3 = boto3.client('s3', region_name=REGION)
    response = s3.get_bucket_encryption(Bucket=REPORTS_BUCKET)
    rules = response.get("ServerSideEncryptionConfiguration", {}).get("Rules", [])
    assert len(rules) > 0, "No encryption rules"
    algo = rules[0].get("ApplyServerSideEncryptionByDefault", {}).get("SSEAlgorithm")
    return f"Encryption: {algo}"


# --- Lambda Environment Tests ---

def test_lambda_has_cognito_config():
    """Test 8.1: Lambda has Cognito environment variables"""
    lambda_client = boto3.client('lambda', region_name=REGION)
    response = lambda_client.get_function_configuration(FunctionName="medibot-api-production")
    env_vars = response.get("Environment", {}).get("Variables", {})
    assert "COGNITO_USER_POOL_ID" in env_vars, "COGNITO_USER_POOL_ID missing"
    assert "COGNITO_CLIENT_ID" in env_vars, "COGNITO_CLIENT_ID missing"
    return "Cognito config present"


def test_lambda_has_dynamodb_config():
    """Test 8.2: Lambda has DynamoDB environment variables"""
    lambda_client = boto3.client('lambda', region_name=REGION)
    response = lambda_client.get_function_configuration(FunctionName="medibot-api-production")
    env_vars = response.get("Environment", {}).get("Variables", {})
    assert "CHAT_TABLE" in env_vars, "CHAT_TABLE missing"
    return f"DynamoDB table: {env_vars.get('CHAT_TABLE')}"


def test_lambda_has_reports_config():
    """Test 8.3: Lambda has Reports bucket environment variable"""
    lambda_client = boto3.client('lambda', region_name=REGION)
    response = lambda_client.get_function_configuration(FunctionName="medibot-api-production")
    env_vars = response.get("Environment", {}).get("Variables", {})
    assert "REPORTS_BUCKET" in env_vars, "REPORTS_BUCKET missing"
    return f"Reports bucket: {env_vars.get('REPORTS_BUCKET')}"


# ============================================
# RUN ALL TESTS
# ============================================

def run_all_tests():
    """Run all test scenarios."""
    print("\n" + "=" * 60)
    print("MEDIBOT TEST SUITE - Phase 1 & Phase 2")
    print("=" * 60)

    all_tests = [
        # Phase 1: Health
        ("Phase 1: Health Endpoint", [
            test_health_endpoint_returns_200,
            test_health_endpoint_returns_model_info,
            test_health_endpoint_returns_version,
        ]),
        # Phase 1: Chat
        ("Phase 1: Chat Functionality", [
            test_chat_simple_greeting,
            test_chat_medical_query,
            test_chat_multilingual_telugu,
        ]),
        # Phase 1: Images
        ("Phase 1: Image Generation", [
            test_image_generation_enabled,
            test_image_generation_max_5,
            test_images_uploaded_to_s3,
        ]),
        # Phase 1: S3 Images
        ("Phase 1: S3 Images Bucket", [
            test_s3_images_bucket_exists,
            test_s3_images_bucket_has_lifecycle,
            test_s3_images_accessible,
        ]),
        # Phase 2: Cognito
        ("Phase 2: Cognito Authentication", [
            test_cognito_user_pool_exists,
            test_cognito_client_exists,
            test_cognito_password_policy,
        ]),
        # Phase 2: DynamoDB
        ("Phase 2: DynamoDB Chat History", [
            test_dynamodb_table_exists,
            test_dynamodb_table_schema,
            test_dynamodb_ttl_enabled,
        ]),
        # Phase 2: Reports
        ("Phase 2: Reports S3 Bucket", [
            test_reports_bucket_exists,
            test_reports_bucket_is_private,
            test_reports_bucket_encrypted,
        ]),
        # Phase 2: Lambda Config
        ("Phase 2: Lambda Configuration", [
            test_lambda_has_cognito_config,
            test_lambda_has_dynamodb_config,
            test_lambda_has_reports_config,
        ]),
    ]

    total_passed = 0
    total_failed = 0

    for category, tests in all_tests:
        print(f"\n{category}")
        print("-" * 40)
        for test in tests:
            result = run_test(test)
            print(f"  {result}")
            if result.passed:
                total_passed += 1
            else:
                total_failed += 1

    print("\n" + "=" * 60)
    print(f"SUMMARY: {total_passed} passed, {total_failed} failed")
    print("=" * 60)

    return total_passed, total_failed


if __name__ == "__main__":
    run_all_tests()
